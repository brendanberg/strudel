var Strudel={};(function(){Strudel.VERSION="0.2 alpha",Strudel.helpers={},Strudel.registerHelper=function(e,t,n){n&&(t.not=n),this.helpers[e]=t},Strudel.registerHelper("helperMissing",function(e){if(arguments.length==2)return undefined;throw new Error("Could not find property '"+e+"'")});var e=Object.prototype.toString,t="[object Function]";Strudel.registerHelper("blockHelperMissing",function(){}),Strudel.registerHelper("with",function(e,t){return!e||Strudel.Utils.isEmpty(e)?t.alternative(this):t.consequent(e)}),Strudel.registerHelper("each",function(e,t){var n=t.consequent,r="",i,s;if(e&&e.length>0)for(i=0,s=e.length;i<s;i++)r+=n(e[i]);else r=t.alternative(this);return r}),Strudel.registerHelper("if",function(e,t){return!e||Strudel.Utils.isEmpty(e)?t.alternative(this):t.consequent(this)}),Strudel.registerHelper("unless",function(e,t){var n=t.alternative;return t.alternative=t.consequent,t.consequent=n,Strudel.helpers["if"].call(this,e,t)}),Strudel.registerHelper("log",function(e,t){Strudel.log(e)})})(),Strudel.compile=function(e){var t=Strudel.Parser.parse(e);return function(e){return String(t.stringWithContext(e))}},Strudel.Exception=function(e){this.message=e},Strudel.EvaluationError=function(e){this.message=e},Strudel.SafeString=function(e){this.string=e},Strudel.SafeString.prototype.toString=function(){return this.string.toString()},function(){var e={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},t=/&(?!\w+;)|[<>"'\`]/g,n=/[&<>"'`]/,r=function(t){return e[t]||"&amp;"};Strudel.Utils={escapeExpression:function(e){return e instanceof Strudel.SafeString?String(e):e==null||e===!1?"":n.test(e)?e.replace(t,r):e},typeOf:function(e){var t=typeof e;return t==="object"&&(e?Object.prototype.toString.call(e)==="[object Array]"&&(t="array"):t="null"),t},isEmpty:function(e){return typeof e=="undefined"?!0:e===null?!0:e===!1?!0:Object.prototype.toString.call(e)==="[object Array]"&&e.length===0?!0:Object.prototype.toString.call(e)==="[object Object]"&&Object.keys(e).length===0?!0:!1}}}(),function(){Strudel.AST={},Strudel.AST.Template=function(e){this.type="template",this.expressionList=e},Strudel.AST.Template.prototype={stringWithContext:function(e){var t,n,r="";for(t=0,n=this.expressionList.length;t<n;t++)r+=Strudel.Utils.escapeExpression(this.expressionList[t].stringWithContext(e));return new Strudel.SafeString(r)}},Strudel.AST.Block=function(e,t,n,r){this.type="block",this.name=e,this.expression=t,this.consequent=n,this.alternative=r},Strudel.AST.Block.prototype={stringWithContext:function(e){var t=this,n=Strudel.helpers[this.name.name||"helperMissing"],r={fn:function(e){return Strudel.Utils.escapeExpression(t.consequent.stringWithContext(e))},inverse:function(e){return Strudel.Utils.escapeExpression(t.alternative.stringWithContext(e))},consequent:function(e){return Strudel.Utils.escapeExpression(t.consequent.stringWithContext(e))},alternative:function(e){return Strudel.Utils.escapeExpression(t.alternative.stringWithContext(e))}},i=this.expression.valueAtPath(e);return new Strudel.SafeString(n.call(e,i,r))}},Strudel.AST.Expression=function(e){this.type="expression",this.helper=function(e){return e},this.searchPath=e},Strudel.AST.Expression.prototype={valueAtPath:function(e){var t,n,r,i=e;for(t=0,n=this.searchPath.length;t<n;t++){r=this.searchPath[t];if(r.type==="name"&&Strudel.Utils.typeOf(i)==="object")i=i[r.name];else{if(r.type!=="index"||Strudel.Utils.typeOf(i)!=="array")throw new Strudel.EvaluationError("Could not traverse specified path in given context.");i=i[r.index]}}return i},wrap:function(e){var t=this.stringWithContext;this.stringWithContext=function(n){return e(t.call(this,n))}},stringWithContext:function(e){var t=this.valueAtPath(e);return Strudel.Utils.isEmpty(t)?"":String(t)}},Strudel.AST.Name=function(e){this.type="name",this.name=e},Strudel.AST.Index=function(e){this.type="index",this.index=e},Strudel.AST.Literal=function(e){this.type="literal",this.string=e},Strudel.AST.Literal.prototype={stringWithContext:function(){return new Strudel.SafeString(this.string)}}}(),Strudel.Parser=function(){function e(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var t={parse:function(t,n){function a(e,t,n){var r=e,i=n-e.length;for(var s=0;s<i;s++)r=t+r;return r}function f(e){var t=e.charCodeAt(0),n,r;return t<=255?(n="x",r=2):(n="u",r=4),"\\"+n+a(t.toString(16).toUpperCase(),"0",r)}function l(e){if(i<o)return;i>o&&(o=i,u=[]),u.push(e)}function c(){var e,t,n;n=i,e=[],t=h();while(t!==null)e.push(t),t=h();return e!==null&&(e=function(e,t){return new Strudel.AST.Template(t)}(n,e)),e===null&&(i=n),e}function h(){var e,t;return t=i,e=y(),e!==null&&(e=function(e,t){return t}(t,e)),e===null&&(i=t),e===null&&(t=i,e=p(),e!==null&&(e=function(e,t){return t}(t,e)),e===null&&(i=t)),e}function p(){var e,n,r,o,u,a,f,h,p,v,g;return v=i,t.substr(i,2)==="@@"?(e="@@",i+=2):(e=null,s===0&&l('"@@"')),e!==null&&(e=function(e){return new Strudel.AST.Literal("@")}(v)),e===null&&(i=v),e===null&&(v=i,g=i,t.substr(i,2)==="@("?(e="@(",i+=2):(e=null,s===0&&l('"@("')),e!==null?(n=d(),n!==null?(t.charCodeAt(i)===41?(r=")",i++):(r=null,s===0&&l('")"')),r!==null?e=[e,n,r]:(e=null,i=g)):(e=null,i=g)):(e=null,i=g),e!==null&&(e=function(e,t){return t}(v,e[1])),e===null&&(i=v),e===null&&(v=i,g=i,t.substr(i,3)==="@(("?(e="@((",i+=3):(e=null,s===0&&l('"@(("')),e!==null?(n=d(),n!==null?(t.substr(i,2)==="))"?(r="))",i+=2):(r=null,s===0&&l('"))"')),r!==null?e=[e,n,r]:(e=null,i=g)):(e=null,i=g)):(e=null,i=g),e!==null&&(e=function(e,t){return t.wrap(function(e){return new Strudel.SafeString(e)}),t}(v,e[1])),e===null&&(i=v),e===null&&(v=i,g=i,t.charCodeAt(i)===64?(e="@",i++):(e=null,s===0&&l('"@"')),e!==null?(n=m(),n!==null?(t.charCodeAt(i)===40?(r="(",i++):(r=null,s===0&&l('"("')),r!==null?(o=d(),o!==null?(t.charCodeAt(i)===41?(u=")",i++):(u=null,s===0&&l('")"')),u!==null?(a=c(),a!==null?(t.substr(i,4)==="@end"?(f="@end",i+=4):(f=null,s===0&&l('"@end"')),f!==null?e=[e,n,r,o,u,a,f]:(e=null,i=g)):(e=null,i=g)):(e=null,i=g)):(e=null,i=g)):(e=null,i=g)):(e=null,i=g)):(e=null,i=g),e!==null&&(e=function(e,t,n,r){return new Strudel.AST.Block(t,n,r)}(v,e[1],e[3],e[5])),e===null&&(i=v),e===null&&(v=i,g=i,t.charCodeAt(i)===64?(e="@",i++):(e=null,s===0&&l('"@"')),e!==null?(n=m(),n!==null?(t.charCodeAt(i)===40?(r="(",i++):(r=null,s===0&&l('"("')),r!==null?(o=d(),o!==null?(t.charCodeAt(i)===41?(u=")",i++):(u=null,s===0&&l('")"')),u!==null?(a=c(),a!==null?(t.substr(i,5)==="@else"?(f="@else",i+=5):(f=null,s===0&&l('"@else"')),f!==null?(h=c(),h!==null?(t.substr(i,4)==="@end"?(p="@end",i+=4):(p=null,s===0&&l('"@end"')),p!==null?e=[e,n,r,o,u,a,f,h,p]:(e=null,i=g)):(e=null,i=g)):(e=null,i=g)):(e=null,i=g)):(e=null,i=g)):(e=null,i=g)):(e=null,i=g)):(e=null,i=g)):(e=null,i=g),e!==null&&(e=function(e,t,n,r,i){return new Strudel.AST.Block(t,n,r,i)}(v,e[1],e[3],e[5],e[7])),e===null&&(i=v))))),e}function d(){var e,n,r,o,u,a;return r=i,o=i,u=i,a=i,e=m(),e!==null?(t.charCodeAt(i)===32?(n=" ",i++):(n=null,s===0&&l('" "')),n!==null?e=[e,n]:(e=null,i=a)):(e=null,i=a),e!==null&&(e=function(e,t){return t}(u,e[0])),e===null&&(i=u),e!==null?(n=v(),n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e!==null&&(e=function(e,t,n){return n.helper=t,n}(r,e[0],e[1])),e===null&&(i=r),e===null&&(r=i,e=v(),e!==null&&(e=function(e,t){return t}(r,e)),e===null&&(i=r)),e}function v(){var e,n,r,o,u,a,f,c,h;a=i,f=i,e=m();if(e!==null){c=i,h=i,t.charCodeAt(i)===46?(r=".",i++):(r=null,s===0&&l('"."')),r!==null?(o=m(),o!==null?r=[r,o]:(r=null,i=h)):(r=null,i=h),r!==null&&(r=function(e,t){return t}(c,r[1])),r===null&&(i=c),r===null&&(c=i,h=i,t.charCodeAt(i)===91?(r="[",i++):(r=null,s===0&&l('"["')),r!==null?(o=g(),o!==null?(t.charCodeAt(i)===93?(u="]",i++):(u=null,s===0&&l('"]"')),u!==null?r=[r,o,u]:(r=null,i=h)):(r=null,i=h)):(r=null,i=h),r!==null&&(r=function(e,t){return t}(c,r[1])),r===null&&(i=c));if(r!==null){n=[];while(r!==null)n.push(r),c=i,h=i,t.charCodeAt(i)===46?(r=".",i++):(r=null,s===0&&l('"."')),r!==null?(o=m(),o!==null?r=[r,o]:(r=null,i=h)):(r=null,i=h),r!==null&&(r=function(e,t){return t}(c,r[1])),r===null&&(i=c),r===null&&(c=i,h=i,t.charCodeAt(i)===91?(r="[",i++):(r=null,s===0&&l('"["')),r!==null?(o=g(),o!==null?(t.charCodeAt(i)===93?(u="]",i++):(u=null,s===0&&l('"]"')),u!==null?r=[r,o,u]:(r=null,i=h)):(r=null,i=h)):(r=null,i=h),r!==null&&(r=function(e,t){return t}(c,r[1])),r===null&&(i=c))}else n=null;n!==null?e=[e,n]:(e=null,i=f)}else e=null,i=f;return e!==null&&(e=function(e,t,n){return new Strudel.AST.Expression(Array(t).concat(n))}(a,e[0],e[1])),e===null&&(i=a),e===null&&(a=i,e=m(),e!==null&&(e=function(e,t){return new Strudel.AST.Expression([t])}(a,e)),e===null&&(i=a)),e}function m(){var e,n,r,o,u;o=i,u=i,/^[a-zA-Z]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[a-zA-Z]"));if(e!==null){n=[],/^[a-zA-Z0-9_]/.test(t.charAt(i))?(r=t.charAt(i),i++):(r=null,s===0&&l("[a-zA-Z0-9_]"));while(r!==null)n.push(r),/^[a-zA-Z0-9_]/.test(t.charAt(i))?(r=t.charAt(i),i++):(r=null,s===0&&l("[a-zA-Z0-9_]"));n!==null?e=[e,n]:(e=null,i=u)}else e=null,i=u;return e!==null&&(e=function(e,t,n){return new Strudel.AST.Name(t+n.join(""))}(o,e[0],e[1])),e===null&&(i=o),e}function g(){var e,n,r;r=i,/^[0-9]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[0-9]"));if(n!==null){e=[];while(n!==null)e.push(n),/^[0-9]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[0-9]"))}else e=null;return e!==null&&(e=function(e,t){return new Strudel.AST.Index(t.join(""))}(r,e)),e===null&&(i=r),e}function y(){var e,n,r;r=i,/^[^@]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[^@]"));if(n!==null){e=[];while(n!==null)e.push(n),/^[^@]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[^@]"))}else e=null;return e!==null&&(e=function(e,t){return new Strudel.AST.Literal(t.join(""))}(r,e)),e===null&&(i=r),e}function b(e){e.sort();var t=null,n=[];for(var r=0;r<e.length;r++)e[r]!==t&&(n.push(e[r]),t=e[r]);return n}function w(){var e=1,n=1,r=!1;for(var s=0;s<Math.max(i,o);s++){var u=t.charAt(s);u==="\n"?(r||e++,n=1,r=!1):u==="\r"||u==="\u2028"||u==="\u2029"?(e++,n=1,r=!0):(n++,r=!1)}return{line:e,column:n}}var r={start:c,template:h,block:p,expression:d,path:v,name:m,index:g,literal:y};if(n!==undefined){if(r[n]===undefined)throw new Error("Invalid rule name: "+e(n)+".")}else n="start";var i=0,s=0,o=0,u=[],E=r[n]();if(E===null||i!==t.length){var S=Math.max(i,o),x=S<t.length?t.charAt(S):null,T=w();throw new this.SyntaxError(b(u),x,S,T.line,T.column)}return E},toSource:function(){return this._source}};return t.SyntaxError=function(t,n,r,i,s){function o(t,n){var r,i;switch(t.length){case 0:r="end of input";break;case 1:r=t[0];break;default:r=t.slice(0,t.length-1).join(", ")+" or "+t[t.length-1]}return i=n?e(n):"end of input","Expected "+r+" but "+i+" found."}this.name="SyntaxError",this.expected=t,this.found=n,this.message=o(t,n),this.offset=r,this.line=i,this.column=s},t.SyntaxError.prototype=Error.prototype,t}();